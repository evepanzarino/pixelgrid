<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat Overlay</title>
<link rel="stylesheet" href="/overlay/css/overlay.css">
<style>
  body { display: flex; flex-direction: column; justify-content: flex-end; height: 100vh; padding: 12px; }

  #chat {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 100%;
    overflow: hidden;
  }

  .msg {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(0,0,0,0.72);
    border-left: 3px solid var(--teal);
    border-radius: 0 var(--border-r) var(--border-r) 0;
    animation: fadeIn 0.25s ease;
    word-break: break-word;
    font-size: 15px;
    line-height: 1.4;
    max-width: 100%;
  }

  .msg.twitch  { border-color: var(--teal); }
  .msg.youtube { border-color: #ff0000; }
  .msg.facebook{ border-color: #1877f2; }

  .badges { font-size: 13px; flex-shrink: 0; }

  .user {
    font-weight: 700;
    flex-shrink: 0;
    margin-right: 4px;
    color: var(--white);
  }

  .text { color: var(--white); }

  .platform-icon { font-size: 11px; opacity: 0.5; flex-shrink: 0; }
</style>
</head>
<body>
<div id="chat"></div>
<script>
  const MAX_MSGS = 20;
  const chat = document.getElementById('chat');
  const WS_URL = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/overlay`;
  let ws;

  function connect() {
    ws = new WebSocket(WS_URL);

    ws.onmessage = e => {
      const data = JSON.parse(e.data);
      if (data.event !== 'chat') return;
      addMessage(data);
    };

    ws.onclose = () => setTimeout(connect, 2000);
    ws.onerror = () => ws.close();
  }

  function addMessage({ platform, user, color, badges, message }) {
    const div = document.createElement('div');
    div.className = `msg ${platform}`;

    const PLATFORM_ICONS = { twitch: 'ðŸ’œ', youtube: 'ðŸ”´', facebook: 'ðŸ”µ' };
    div.innerHTML = `
      <span class="badges">${badges || ''}</span>
      <span class="user">${esc(user)}</span>
      <span class="text">${esc(message)}</span>
      <span class="platform-icon">${PLATFORM_ICONS[platform] || ''}</span>
    `;

    chat.appendChild(div);
    while (chat.children.length > MAX_MSGS) chat.removeChild(chat.firstChild);
    chat.scrollTop = chat.scrollHeight;
  }

  function esc(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  connect();
</script>
</body>
</html>
